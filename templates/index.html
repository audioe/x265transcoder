<!DOCTYPE html>
<html>
<head>
    <title>x265 Transcoder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>x265 Transcoder</h1>
        <h2>Version {{ version }}</h2>
        <hr>
        {% if transcoder_status == True %}
        {% if job | contains("films") %}
        <p>There is already a transcode job in progress for a Film:</p>
        {% else %}
        <p>There is already a transcode job in progress for a TV Show:</p>
        <p>{{ job }}</p>
        {% endif %}
        {% else %}
        <form method="post" action="{{ url_for('load_directories') }}">
            <label>What type of library are you looking to Transcode?:</label>
            <div class="library-type">
                <input type="radio" id="shows" name="parent_dir" value="{{ config['libraries']['shows'] }}">
                <label for="shows">Shows</label>
            </div>
            <div class="library-type">
                <input type="radio" id="films" name="parent_dir" value="{{ config['libraries']['films'] }}">
                <label for="films">Films</label>
            </div>
            <input type="submit" value="Load Directories">
        </form>
        {% endif %}
        {% if directories %}
        <form method="post" action="{{ url_for('load_subdirectories') }}">
            <input type="hidden" id="parent_dir" name="parent_dir" value="{{ parent_dir or '/shows' }}">
            <label for="folder">Folder:</label>
            <select name="folder" id="folder">
                {% for directory in directories %}
                <option value="{{ directory.path }}">{{ directory.name }}</option>
                {% endfor %}
            </select>
            <input type="submit" value="Load Subdirectories">
        </form>
        {% elif subdirectories %}
        {% if shows %}
        <p>Show selected: <span style="font-weight: bold; font-size: 1.2em;">{{ current_dir.split('/')[-1] }}</span></p>
        {% elif films %}
        <p>Select a Film directory:</p>
        {% endif %}
        <form method="post" action="{{ url_for('run') }}">
            <label for="folder">Folder:</label>
            <select name="folder" id="folder">
                {% for subdirectory in subdirectories %}
                <option value="{{ subdirectory.path }}">{{ subdirectory.name }}</option>
                {% endfor %}
            </select>
            <label for="include">Include:</label>
            <input type="text" id="include" name="include" value="{{ include }}">
            <label for="quality" class="tooltip-label">
                Choose a Quality:
                <span class="info-icon" title="This sets the quality of the transcoded video. 18 is considered the best quality, but largest resulting file size. 25 would result in the smallest file size, but may be visually noticeable. 23 is a solid middle-ground for quality vs file size if unsure."></span>
            </label>
            <div class="slider-container">
                <input type="range" id="quality" name="quality" min="18" max="25" step="1" value="23" oninput="updateQualityValue(this.value)">
                <span id="quality-value">23
            </div>
            <label for="delete">Delete after Transcoding?</label>
            <label class="switch">
                <input type="checkbox" id="delete" name="delete" value="Yes" checked>
                <span class="slider round">
            </label>
            <input type="submit" value="Submit">
        </form>
        {% endif %}
    </div>

    <!-- Loading icon -->
    <div id="loading-icon" style="display: none;">
        <img src="{{ url_for('static', filename='loading.gif') }}" alt="Loading...">
    </div>

    <script>
        function updateQualityValue(value) {
            document.getElementById('quality-value').textContent = value;
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const loadingIcon = document.getElementById('loading-icon');

            form.addEventListener('submit', function(event) {
                event.preventDefault();

                // Show the loading icon
                loadingIcon.style.display = 'flex';

                // Send the AJAX request
                const formData = new FormData(form);
                fetch('{{ url_for('load_directories') }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(data => {
                    // Update the page with the new content
                    document.body.innerHTML = data;
                })
                .catch(error => {
                    console.error('Error:', error);
                })
                .finally(() => {
                    // Hide the loading icon
                    loadingIcon.style.display = 'none';
                });
            });
        });
    </script>
</body>
</html>
